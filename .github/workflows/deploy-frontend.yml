name: Deploy Frontend to S3/CloudFront

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './frontend/package.json'

      - name: Install dependencies
        run: npm install --ignore-scripts

      - name: Build frontend
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_PUBLIC_TESTS_URL: ${{ secrets.NEXT_PUBLIC_PUBLIC_TESTS_URL || 'https://d2zt8ia21te5mv.cloudfront.net' }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Sync to S3
        run: |
          aws s3 sync ./out/ s3://emotioxv2-frontend-041238861016 --delete
          
      - name: Configure S3 website hosting
        run: |
          aws s3 website s3://emotioxv2-frontend-041238861016 --index-document index.html --error-document error.html

      - name: Invalidate CloudFront cache
        continue-on-error: true
        run: |
          echo "üîÑ Invalidating CloudFront cache..."
          if [ -n "${{ secrets.FRONTEND_CLOUDFRONT_DISTRIBUTION_ID }}" ] && [ "${{ secrets.FRONTEND_CLOUDFRONT_DISTRIBUTION_ID }}" != "none" ]; then
            aws cloudfront create-invalidation \
              --distribution-id ${{ secrets.FRONTEND_CLOUDFRONT_DISTRIBUTION_ID }} \
              --paths "/*" && echo "‚úÖ CloudFront cache invalidated" || {
              echo "‚ö†Ô∏è  CloudFront invalidation failed, but deployment continues"
              exit 0
            }
          else
            echo "‚ö†Ô∏è  FRONTEND_CLOUDFRONT_DISTRIBUTION_ID not set - skipping CloudFront invalidation"
          fi

      - name: Verify deployment
        run: |
          echo "üîç Verifying deployment..."
          sleep 30  # Wait for CloudFront to update
          
          # Test S3 website endpoint
          if curl -f -s "http://emotioxv2-frontend-041238861016.s3-website-us-east-1.amazonaws.com" > /dev/null; then
            echo "‚úÖ S3 website endpoint is accessible"
          else
            echo "‚ö†Ô∏è  S3 website endpoint not yet accessible (DNS propagation may take time)"
          fi
          
          # Test CloudFront if configured
          if [ -n "${{ secrets.FRONTEND_CLOUDFRONT_DISTRIBUTION_ID }}" ]; then
            CLOUDFRONT_DOMAIN=$(aws cloudfront get-distribution \
              --id ${{ secrets.FRONTEND_CLOUDFRONT_DISTRIBUTION_ID }} \
              --query 'Distribution.DomainName' \
              --output text)
            
            echo "üåê CloudFront URL: https://$CLOUDFRONT_DOMAIN"
            
            # Verify CloudFront is accessible
            for i in {1..5}; do
              if curl -f -s "https://$CLOUDFRONT_DOMAIN" > /dev/null; then
                echo "‚úÖ CloudFront is accessible"
                break
              else
                echo "‚è≥ Attempt $i: Waiting for CloudFront to update..."
                sleep 10
              fi
            done
          fi

      - name: Deployment complete
        run: |
          echo "‚úÖ Frontend deployed successfully"
          echo ""
          echo "üìä Deployment summary:"
          echo "  - S3 Bucket: emotioxv2-frontend-041238861016"
          if [ -n "${{ secrets.FRONTEND_CLOUDFRONT_DISTRIBUTION_ID }}" ]; then
            CLOUDFRONT_DOMAIN=$(aws cloudfront get-distribution \
              --id ${{ secrets.FRONTEND_CLOUDFRONT_DISTRIBUTION_ID }} \
              --query 'Distribution.DomainName' \
              --output text)
            echo "  - CloudFront Distribution: ${{ secrets.FRONTEND_CLOUDFRONT_DISTRIBUTION_ID }}"
            echo ""
            echo "üåê URLs:"
            echo "  - S3: http://emotioxv2-frontend-041238861016.s3-website-us-east-1.amazonaws.com"
            echo "  - CloudFront: https://$CLOUDFRONT_DOMAIN"
          else
            echo ""
            echo "üåê URLs:"
            echo "  - S3: http://emotioxv2-frontend-041238861016.s3-website-us-east-1.amazonaws.com"
            echo "  - Direct S3: https://emotioxv2-frontend-041238861016.s3.us-east-1.amazonaws.com/index.html"
          fi