name: ğŸš€ Deploy Public Tests to S3/CloudFront

on:
  push:
    branches: [main, develop]
    paths:
      - 'public-tests/**'
      - '.github/workflows/deploy-public-tests-s3.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

env:
  NODE_VERSION: '20'
  BUCKET: emotioxv2-public-tests-041238861016
  REGION: us-east-1

jobs:
  deploy:
    name: ğŸš€ Deploy to S3/CloudFront
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: ğŸ“¦ Install dependencies
        run: |
          cd public-tests
          npm install --ignore-scripts --prefer-offline --no-audit

      - name: ğŸ” Verify environment variables
        run: |
          echo "ğŸ” Verificando variables de entorno..."
          echo "BUCKET: ${{ env.BUCKET }}"
          echo "REGION: ${{ env.REGION }}"
          
          # Set CloudFront Distribution ID from secret
          CLOUDFRONT_ID="${{ secrets.PUBLIC_TESTS_CLOUDFRONT_DISTRIBUTION_ID }}"
          echo "CLOUDFRONT_DISTRIBUTION_ID=${CLOUDFRONT_ID:-none}" >> $GITHUB_ENV
          echo "CLOUDFRONT_DISTRIBUTION_ID: ${CLOUDFRONT_ID:-none}"

          if [ -z "${{ env.BUCKET }}" ]; then
            echo "âŒ Error: BUCKET no estÃ¡ definido"
            exit 1
          fi

          if [ -z "$CLOUDFRONT_ID" ] || [ "$CLOUDFRONT_ID" = "none" ]; then
            echo "âš ï¸  Warning: PUBLIC_TESTS_CLOUDFRONT_DISTRIBUTION_ID not set - deployment will use S3 only"
          fi

      - name: ğŸ—ï¸ Build application
        run: |
          cd public-tests
          echo "ğŸ—ï¸ Construyendo aplicaciÃ³n..."
          npm run build:ci
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
          NODE_ENV: production

      - name: ğŸ” Verify build output
        run: |
          cd public-tests
          echo "ğŸ” Verificando build..."
          ls -la dist/

          if [ ! -f "dist/index.html" ]; then
            echo "âŒ Error: index.html no encontrado en dist/"
            exit 1
          fi

          echo "âœ… Build verificado correctamente"

      - name: ğŸ”§ Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.REGION }}

      - name: ğŸš€ Deploy to S3
        run: |
          echo "ğŸš€ Iniciando despliegue a S3..."
          ./scripts/deploy/deploy-public-tests.sh
        env:
          BUCKET: ${{ env.BUCKET }}
          REGION: ${{ env.REGION }}
          CLOUDFRONT_DISTRIBUTION_ID: ${{ env.CLOUDFRONT_DISTRIBUTION_ID }}

      - name: ğŸ“Š Upload build info
        run: |
          echo "ğŸ“Š Creando build-info.json..."
          cat > /tmp/build-info.json << EOF
          {
            "build_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}",
            "commit_short": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "workflow": "${{ github.workflow }}",
            "run_id": "${{ github.run_id }}",
            "actor": "${{ github.actor }}",
            "repository": "${{ github.repository }}"
          }
          EOF

          echo "ğŸ“¤ Subiendo build-info.json a S3..."
          aws s3 cp /tmp/build-info.json s3://${{ env.BUCKET }}/build-info.json \
            --cache-control "no-cache,no-store,must-revalidate" \
            --region ${{ env.REGION }}

          echo "âœ… build-info.json subido correctamente"
          cat /tmp/build-info.json

      - name: ğŸ” Verify deployment
        run: |
          echo "ğŸ” Verificando despliegue..."

          # Verificar archivos principales
          aws s3 ls s3://${{ env.BUCKET }}/index.html --region ${{ env.REGION }} || {
            echo "âŒ Error: index.html no encontrado en S3"
            exit 1
          }

          # Verificar endpoints dinÃ¡micos
          aws s3 ls s3://${{ env.BUCKET }}/config/endpoints.js --region ${{ env.REGION }} || {
            echo "âš ï¸ Warning: endpoints.js no encontrado en S3"
          }

          # Verificar build-info.json
          aws s3 ls s3://${{ env.BUCKET }}/build-info.json --region ${{ env.REGION }} || {
            echo "âš ï¸ Warning: build-info.json no encontrado en S3"
          }

          echo "âœ… Despliegue verificado correctamente"

      - name: ğŸŒ Test CloudFront accessibility
        if: env.CLOUDFRONT_DISTRIBUTION_ID != 'none' && env.CLOUDFRONT_DISTRIBUTION_ID != ''
        continue-on-error: true
        run: |
          echo "ğŸŒ Probando accesibilidad de CloudFront..."

          # Validar que CloudFront ID estÃ¡ configurado
          if [ -z "${{ env.CLOUDFRONT_DISTRIBUTION_ID }}" ] || [ "${{ env.CLOUDFRONT_DISTRIBUTION_ID }}" = "none" ]; then
            echo "âš ï¸ CloudFront Distribution ID no configurado - saltando test"
            exit 0
          fi

          # Obtener dominio de CloudFront
          CLOUDFRONT_DOMAIN=$(aws cloudfront get-distribution \
            --id ${{ env.CLOUDFRONT_DISTRIBUTION_ID }} \
            --region ${{ env.REGION }} \
            --query 'Distribution.DomainName' \
            --output text 2>/dev/null || echo "")

          if [ -z "$CLOUDFRONT_DOMAIN" ]; then
            echo "âš ï¸ No se pudo obtener el dominio de CloudFront"
            exit 0
          fi

          echo "CloudFront Domain: $CLOUDFRONT_DOMAIN"

          # Esperar un poco para que la invalidaciÃ³n se propague
          sleep 30

          # Probar acceso
          curl -I "https://$CLOUDFRONT_DOMAIN" || {
            echo "âš ï¸ Warning: No se pudo verificar CloudFront (puede ser normal durante invalidaciÃ³n)"
          }
          
      - name: ğŸŒ S3-only deployment (no CloudFront)
        if: env.CLOUDFRONT_DISTRIBUTION_ID == 'none'
        run: |
          echo "ğŸ“ Usando solo S3 website hosting (sin CloudFront)"
          echo "ğŸŒ URL S3: http://${{ env.BUCKET }}.s3-website-${{ env.REGION }}.amazonaws.com"

      - name: ğŸ“Š Deployment summary
        run: |
          echo "## ğŸš€ Despliegue Completado" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Bucket S3:** ${{ env.BUCKET }}" >> $GITHUB_STEP_SUMMARY
          echo "**RegiÃ³n:** ${{ env.REGION }}" >> $GITHUB_STEP_SUMMARY
          CLOUDFRONT_ID_DISPLAY="${{ env.CLOUDFRONT_DISTRIBUTION_ID }}"
          if [ -z "$CLOUDFRONT_ID_DISPLAY" ]; then
            CLOUDFRONT_ID_DISPLAY="none"
          fi
          echo "**CloudFront Distribution ID:** $CLOUDFRONT_ID_DISPLAY" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ Checklist:" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Build completado" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Archivos subidos a S3" >> $GITHUB_STEP_SUMMARY
          echo "- [x] build-info.json generado y subido" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Endpoints dinÃ¡micos copiados" >> $GITHUB_STEP_SUMMARY
          if [ "${{ env.CLOUDFRONT_DISTRIBUTION_ID }}" != "none" ] && [ -n "${{ env.CLOUDFRONT_DISTRIBUTION_ID }}" ]; then
            echo "- [x] CachÃ© de CloudFront invalidado" >> $GITHUB_STEP_SUMMARY
          else
            echo "- [ ] CachÃ© de CloudFront (no configurado)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”— URLs:" >> $GITHUB_STEP_SUMMARY
          echo "- **S3:** https://${{ env.BUCKET }}.s3.${{ env.REGION }}.amazonaws.com" >> $GITHUB_STEP_SUMMARY
          CLOUDFRONT_ID_CHECK="${{ env.CLOUDFRONT_DISTRIBUTION_ID }}"
          if [ -n "$CLOUDFRONT_ID_CHECK" ] && [ "$CLOUDFRONT_ID_CHECK" != "none" ]; then
            CLOUDFRONT_DOMAIN=$(aws cloudfront get-distribution \
              --id "$CLOUDFRONT_ID_CHECK" \
              --region ${{ env.REGION }} \
              --query 'Distribution.DomainName' \
              --output text 2>/dev/null || echo "N/A")
            if [ "$CLOUDFRONT_DOMAIN" != "N/A" ] && [ -n "$CLOUDFRONT_DOMAIN" ]; then
              echo "- **CloudFront:** https://$CLOUDFRONT_DOMAIN" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **CloudFront:** ID configurado pero dominio no disponible" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- **CloudFront:** No configurado" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ‰ Success notification
        if: success()
        run: |
          echo "ğŸ‰ Â¡Despliegue completado exitosamente!"
          echo "ğŸ“… Timestamp: $(date)"
          echo "ğŸ”„ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Autor: ${{ github.actor }}"

  notify:
    name: ğŸ“¢ Notify deployment status
    runs-on: ubuntu-latest
    needs: deploy
    if: always()

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.REGION }}

      - name: ğŸ“¢ Notify success
        if: needs.deploy.result == 'success'
        run: |
          echo "âœ… Despliegue de public-tests a S3/CloudFront completado exitosamente"
          
          # Obtener dominio de CloudFront si estÃ¡ configurado
          CLOUDFRONT_ID="${{ secrets.PUBLIC_TESTS_CLOUDFRONT_DISTRIBUTION_ID }}"
          if [ -n "$CLOUDFRONT_ID" ] && [ "$CLOUDFRONT_ID" != "none" ]; then
            CLOUDFRONT_DOMAIN=$(aws cloudfront get-distribution \
              --id "$CLOUDFRONT_ID" \
              --region ${{ env.REGION }} \
              --query 'Distribution.DomainName' \
              --output text 2>/dev/null || echo "")
            
            if [ -n "$CLOUDFRONT_DOMAIN" ]; then
              echo "ğŸ”— CloudFront URL: https://$CLOUDFRONT_DOMAIN"
            else
              echo "ğŸ”— S3 URL: http://${{ env.BUCKET }}.s3-website-${{ env.REGION }}.amazonaws.com"
            fi
          else
            echo "ğŸ”— S3 URL: http://${{ env.BUCKET }}.s3-website-${{ env.REGION }}.amazonaws.com"
          fi

      - name: ğŸ“¢ Notify failure
        if: needs.deploy.result == 'failure'
        run: |
          echo "âŒ Despliegue de public-tests a S3/CloudFront fallÃ³"
          echo "ğŸ” Revisar logs para mÃ¡s detalles"
