#!/bin/sh

echo "üöÄ Running pre-commit checks..."

# TypeScript compilation
echo "üìù Checking TypeScript compilation..."
cd backendV2 && npx tsc --noEmit || exit 1
cd ../frontend && npm run build > /dev/null 2>&1 || exit 1
cd ../shared && npx tsc --noEmit || exit 1
cd ../public-tests && npx tsc --noEmit || exit 1
cd ..

# Linting
echo "üîç Running linters..."
cd backendV2 && npm run lint || exit 1
cd ../frontend && npm run lint || exit 1
cd ../shared && npm run lint || exit 1
cd ../public-tests && npm run lint || exit 1
cd ..

# Check for prohibited any/unknown types (WARNING ONLY - not blocking)
echo "üö´ Checking for prohibited any/unknown types..."
ANY_COUNT=$(grep -r ": any\|any\[\]\|any>" --include="*.ts" --include="*.tsx" --exclude-dir=node_modules --exclude-dir=.next --exclude-dir=dist --exclude-dir=build . | grep -v "//.*any\|\.d\.ts:" | wc -l || echo "0")
if [ "$ANY_COUNT" -gt 0 ]; then
  echo "‚ö†Ô∏è  WARNING: Found $ANY_COUNT 'any' types - consider replacing with specific types"
fi

UNKNOWN_COUNT=$(grep -r ": unknown\|unknown\[\]\|unknown>" --include="*.ts" --include="*.tsx" --exclude-dir=node_modules --exclude-dir=.next --exclude-dir=dist --exclude-dir=build . | grep -v "isValidUser\|parseJwt\|//.*unknown\|\.d\.ts:" | wc -l || echo "0")
if [ "$UNKNOWN_COUNT" -gt 0 ]; then
  echo "‚ö†Ô∏è  WARNING: Found $UNKNOWN_COUNT 'unknown' types - consider replacing with specific types"
fi

# Tests (optional for now)
echo "üß™ Running tests..."
cd backendV2 && npm test || echo "‚ö†Ô∏è Backend tests not configured or failed"
cd ../frontend && npm test || echo "‚ö†Ô∏è Frontend tests not configured or failed"
cd ..

echo "‚úÖ All pre-commit checks passed!"
